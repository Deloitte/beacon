!function(){"use strict";function t(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{c(s.next(t))}catch(t){o(t)}}function a(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}c((s=s.apply(t,e||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class e{constructor({name:t,isEnabled:e}){this.name=t,this.isEnabled=e,this.color=this.getColor(t)}getColor(t){let e=0;if(0===t.length)return"";for(let i=0;i<t.length;i++)e=t.charCodeAt(i)+((e<<5)-e),e&=e;let i="#";for(let t=0;t<3;t++){i+=("00"+(e>>8*t&255).toString(16)).substr(-2)}return i.toString()}info(...t){const e=`color: ${this.color}; font-weight: bold;`;this.isEnabled&&console.info(`%c${this.name}\n`,e,...t)}debug(...t){this.isEnabled&&console.log(`%c${this.name}\n`,`color: ${this.color}; font-weight: bold;`,...t)}error(...t){this.isEnabled&&console.error(`%c${this.name}\n`,"color: white; background: #ce1a43; font-weight: bold;",...t)}warn(...t){this.isEnabled&&console.warn(`%c${this.name}\n`,"color: white; background: #bf7506; font-weight: bold;",...t)}}function i(t){const e=Object.create(null);for(const[i,s]of t)e[i]=s;return e}function s(t,e,i){t.addEventListener(e,i,!1)}function n(){const t=crypto.getRandomValues(new Uint16Array(8)),e=[].map.call(t,t=>t.toString(16).padStart(4,"0")).join(""),i=(t[5]>>12&3|8).toString(16);return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${i}${e.substr(17,3)}-${e.substr(20,12)}`}function o(){return Math.floor((new Date).getTime()/1e3)}class r{constructor(){this.localStorageSupported="undefined"!=typeof window}set(t,e){this.localStorageSupported&&localStorage.setItem(t,e)}get(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e||null}return null}setJson(t,e){this.localStorageSupported&&localStorage.setItem(t,JSON.stringify(e))}getJson(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e?JSON.parse(e):void 0}}remove(t){this.localStorageSupported&&localStorage.removeItem(t)}clear(){this.localStorageSupported&&localStorage.clear()}}class a{constructor(t,i){this.config=t,this.core=i,this.logger=new e({name:"SessionController",isEnabled:this.config.log&&this.config.settings.session.log})}init(){return t(this,void 0,void 0,function*(){const t=new r;if(this.session=yield t.getJson(this.config.settings.session.storeName),this.session){const t=o();t-this.session.lastEvent>=this.config.settings.session.duration?(this.logger.debug("Session timeout exceeded, starting new session"),yield this.startSession(this.session)):(this.logger.debug(`Session active and not timed out, extending session ${this.session.sessionId}`),this.extendSession(Object.assign(Object.assign({},this.session),{lastEvent:t})))}else this.logger.debug("No active session"),yield this.startSession()})}trackSessionEnd(e){return t(this,void 0,void 0,function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionEnded",e))})}trackSessionStart(e){return t(this,void 0,void 0,function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionStarted",e))})}startSession(){return t(this,arguments,void 0,function*(t=void 0){const e=o();t&&(yield this.trackSessionEnd(t)),this.sessionId=n();const i={sessionId:this.sessionId,firstEvent:e,lastEvent:e};yield(new r).setJson(this.config.settings.session.storeName,i),yield this.trackSessionStart(i)})}extendSession(e){return t(this,void 0,void 0,function*(){this.sessionId=e.sessionId,yield(new r).setJson(this.config.settings.session.storeName,e)})}}class c{constructor(t,i){this.config=t,this.core=i,this.logger=new e({name:"UserController",isEnabled:this.config.log&&this.config.settings.user.log})}identify(e,i){return t(this,void 0,void 0,function*(){let t={external_id:e,type:"identified"};i&&(t=Object.assign(Object.assign({},t),i)),yield this.core.processActivity("identity","identified",t)})}seedAnonymous(e){return t(this,void 0,void 0,function*(){this.logger.debug("Seeding anonymous identity"),this.userId=n();const t={id:this.userId,type:"anonymous"};this.config.settings.user.trackEvents&&(yield this.core.processActivity("identity","anonymous",t)),yield e.setJson(this.config.settings.user.storeName,t)})}attemptIdentity(e){return t(this,void 0,void 0,function*(){this.config.settings.user.seedAnonymous&&(yield this.seedAnonymous(e))})}init(){return t(this,void 0,void 0,function*(){const t=new r,e=yield t.getJson(this.config.settings.user.storeName);e?(this.userId=e.id,this.logger.debug(`identity is set as ${this.userId}`)):yield this.attemptIdentity(t)})}}const d=["title"],l=["entity"],g=["entity-id"],h=["entity-props"],u=["props"];function f(t,e){switch(e){case"userAndSession":t.user.enabled=!0,t.session.enabled=!0;break;case"user":t.user.enabled=!0,t.session.enabled=!1;break;case"session":t.user.enabled=!1,t.session.enabled=!0;break;case"noPii":t.user.enabled=!1,t.session.enabled=!1}return t}class p{constructor(t,i,s){this.parent=t,this.core=i,this.logger=new e({name:s,isEnabled:this.core.config.log}),this.enabled=!0}sendTrack(t,e,i){this.logger.debug("track",{type:t,event:e,properties:i}),this.core&&this.core.processActivity(t,e,i)}}function m(t,e){for(const i of t){const t=e.querySelector(`meta[name=${i}]`);if(t)return t.getAttribute("content")}}function y(t,e){const i=new Map;for(const s of t){const t=e.querySelector(`meta[name^=${s}]`);t&&i.set(t.name.replace(`${s}-`,""),t.getAttribute("content"))}return i}function b(t,e){return e.title?e.title:"PageViewed"}function v(t,e){const{document:s}=e;return i(y(t.config.settings.page.properties,s))}function w(t,e){var s;let n,o,r;if(n=m(null===(s=t.config.settings.page)||void 0===s?void 0:s.entity,e),n)return o=m(t.config.settings.page.entityId,e),r=y(t.config.settings.page.entityProps,e),{type:n,id:o,props:r?i(r):{}}}class k extends p{constructor(t,e){super(t,e,"PageTracker"),this.waitForIt=()=>new Promise(t=>setTimeout(t,600))}init(){return t(this,void 0,void 0,function*(){yield this.waitForIt(),yield this.handleStates(),yield this.track()})}handleStates(){return t(this,void 0,void 0,function*(){const e=history.pushState;history.pushState=function(...t){const i=e.apply(this,t);return window.dispatchEvent(new Event("pushstate")),window.dispatchEvent(new Event("locationchange")),i};const i=history.replaceState;history.replaceState=function(...t){const e=i.apply(this,t);return window.dispatchEvent(new Event("replacestate")),window.dispatchEvent(new Event("locationchange")),e},window.addEventListener("popstate",function(){window.dispatchEvent(new Event("locationchange"))}),window.addEventListener("locationchange",()=>t(this,void 0,void 0,function*(){yield this.waitForIt(),yield this.track()}),!1)})}track(){return t(this,void 0,void 0,function*(){const t={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)};this.sendTrack("page","PageViewed",Object.assign(Object.assign({page:t.pageName},t.properties),t.entity&&{entity:t.entity}))})}}class S extends p{constructor(t,e){super(t,e,"ClickTracker"),this.limitClickText=t=>t.length>100?t.substring(0,100):t}init(){return t(this,void 0,void 0,function*(){s(parent,"click",t=>{this.track(t)})})}getElementNameByTagName(t){return"A"===t?"Link":"BUTTON"===t?"Button":"DIV"===t?"Div":"FORM"===t?"Form":"INPUT"===t?"Input":"Element"}track(t,e={}){if(t){void 0===t&&(t=window.event);const i="target"in t?t.target:t.srcElement;if(i){let s,n={event:t,properties:e};if(s=this.getMetaFromTrackedElement(this.getElementNameByTagName(i.tagName),i,t),s.dontTrack)return!1;{const t={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)};n={event:s.event,properties:Object.assign(Object.assign(Object.assign(Object.assign({},t.properties),s.properties),t.pageName&&{page:t.pageName}),t.entity||s.entity&&{entity:Object.assign(Object.assign({},t.entity),s.entity)})},this.sendTrack("track",n.event,n.properties)}}}return!1}getXPathForElement(t,e){var i="CSS1Compat"===document.compatMode?document.documentElement:document.body,s=[e.clientX+i.scrollLeft,e.clientY+i.scrollTop],n=this.getPathToElement(t),o=this.getPageXY(t);return{xpath:n,location:{x:s[0]-o[0],y:s[1]-o[1]}}}getPageXY(t){for(var e=0,i=0;t;)e+=t.offsetLeft,i+=t.offsetTop,t=t.offsetParent;return[e,i]}getPathToElement(t){if(""!==t.id)return'id("'+t.id+'")';if(t===document.body)return t.tagName;for(var e=0,i=t.parentNode.childNodes,s=0;s<i.length;s++){var n=i[s];if(n===t)return this.getPathToElement(t.parentNode)+"/"+t.tagName+"["+(e+1)+"]";1===n.nodeType&&n.tagName===t.tagName&&e++}return""}getMetaFromTrackedElement(t,e,i){let s=`${t}Clicked`;const n={},o={};if(n.element=e.tagName.toLowerCase(),e.hasAttributes()){if(e.getAttribute("data-track")&&"false"===e.getAttribute("data-track"))return{dontTrack:!0};for(const t of e.attributes)t.name.startsWith("data-")?("data-event"===t.name&&(s=t.value),"data-entity"===t.name&&(o.type=t.value),"data-entity-id"===t.name&&(o.id=t.value)):n[t.name]=this.limitClickText(t.value);"password"===n.type&&n.value&&delete n.value}e.innerText&&(n.inner_text=this.limitClickText(e.innerText)),e.textContent&&(n.textContent=this.limitClickText(e.textContent));try{const{xpath:t,location:s}=this.getXPathForElement(e,i);n.xpath=t,n.location=s}catch(t){this.logger.error("Error getting xpath and position",t)}return{event:s,entity:o,properties:n}}}class E extends p{constructor(t,e){super(t,e,"FormTracker")}init(){return t(this,void 0,void 0,function*(){0===document.querySelectorAll("form").length&&(yield new Promise(t=>setTimeout(t,2e3)));const t=document.querySelectorAll("form");for(const e of t)s(e,"submit",t=>{this.track(t)})})}track(t){if(t){t.preventDefault();const e=[],i=t.target;if(i){const t={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)},s=Object.assign(Object.assign({},i.getAttribute("id")&&{id:i.getAttribute("id")}),i.getAttribute("class")&&{class:i.getAttribute("class")});if(i.elements)for(const t of i.elements)t.id&&""!==t.id&&e.push({key:t.id,value:t.value});this.sendTrack("track","FormSubmitted",Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t.properties),s&&{form:s}),e&&{formValues:e}),t.pageName&&{page:t.pageName}),t.entity&&{entity:t.entity}))}}return!1}}let A;class T{constructor(t,i=[]){var s;A=this,this.loaded=!1,this.enabled=!1,this.window=t,this.trackers=new Map,this.config={log:!1,identity:"noPii",apiRoot:"http://localhost",settings:(s="noPii",f({transport:{apiRoute:"/api/activity",method:"sendBeacon"},queue:{store:"localStorage",storeName:"beacon-queue"},page:{eventName:d,entity:l,entityId:g,entityProps:h,properties:u},user:{log:!0,enabled:!1,seedAnonymous:!0,trackEvents:!0,storeType:"localStorage",storeName:"beacon-user"},context:{trackUserAgent:!1},session:{log:!0,enabled:!1,trackEvents:!0,storeType:"localStorage",storeName:"beacon-session",duration:300}},s)),trackers:[]},this.logger=new e({name:"Core",isEnabled:!1}),this.sessionController=new a(this.config,this),this.userController=new c(this.config,this)}getConfig(){return this.config}registerTrackers(){return t(this,void 0,void 0,function*(){for(const t of this.config.trackers)switch(t){case"page":this.trackers.set("page",new k(this.window,this));break;case"click":this.trackers.set("click",new S(this.window,this));break;case"form":this.trackers.set("form",new E(this.window,this));break;default:this.logger.warn(`Tracker ${t} doesnt exist and cannot be registered`)}this.trackers.forEach(e=>t(this,void 0,void 0,function*(){e.init&&(yield e.init())}))})}init(e){return t(this,void 0,void 0,function*(){e&&this.applyConfig(e),this.config.settings.user.enabled&&(yield this.userController.init()),this.config.settings.session.enabled&&(yield this.sessionController.init()),yield this.registerTrackers(),this.loaded=!0})}mergeConfig(t,e){return Object.keys(e).forEach(i=>{!t.hasOwnProperty(i)||"object"!=typeof t[i]||t[i]instanceof Array?t[i]=e[i]:this.mergeConfig(t[i],e[i])}),t}applyConfig(t){this.mergeConfig(this.config,t),this.logger.isEnabled=this.config.log,this.logger.debug("config loaded",t),this.logger.debug("version 0.1.6, built on December 13, 2025 13:29:15"),this.config.settings=f(this.config.settings,this.config.identity),this.config.apiRoot.endsWith("/")&&(this.config.apiRoot=this.config.apiRoot.slice(0,-1)),this.enabled=!0}identify(t,e){this.userController.identify(t,e)}track(t,e,i){if("track"===t||"event"===t)this.processActivity(t,e,i);else if("click"===t){let e=this.trackers.get(t);e||(e=new S(this.window,this))}else if("page"===t){let e=this.trackers.get(t);e||(e=new k(this.window,this)),e.track()}else if("form"===t){const e=this.trackers.get(t);(null==e?void 0:e.track)&&e.track()}else this.logger.warn(`track type of ${t} doesn't exist`)}trackClick(t){A.track("click","Link",t)}trackButtonClick(t){A.track("click","Button",t)}trackCurrentPage(){A.track("page","PageViewed",{})}autoTrack(){this.trackers.forEach(t=>{t.track&&t.track()})}processActivity(e,i,s){return t(this,void 0,void 0,function*(){const{screen:{width:t,height:n},navigator:{language:o,userAgent:r},location:{hostname:a,pathname:c,search:d},document:l}=window;let g={channel:"web",screen:`${t}x${n}`,language:o,url:`${c}${d}`,referrer:l.referrer,hostname:a};this.config.settings.context.trackUserAgent&&(g=Object.assign(Object.assign({},g),{userAgent:r})),this.userController&&this.userController.userId&&(g=Object.assign({userId:this.userController.userId},g)),this.sessionController&&this.sessionController.sessionId&&(g=Object.assign({sessionId:this.sessionController.sessionId},g));const h={type:e,event:i,properties:s,context:g,originalTimestamp:(new Date).toISOString()};this.logger.debug("sendToApi",h),yield this.sendActivity(h)})}sendActivity(e){return t(this,void 0,void 0,function*(){if("sendBeacon"===this.config.settings.transport.method){const t=new Blob([JSON.stringify(e)]);navigator.sendBeacon(`${this.config.apiRoot}${this.config.settings.transport.apiRoute}`,t)}})}}(t=>{if(!t.beacon){t.beacon=new T(t);const e=document.getElementById("beaconScript");if(e){const i=e.getAttribute("data-api-root"),s="true"===e.getAttribute("data-log"),n=e.getAttribute("data-identity")?e.getAttribute("data-identity"):"noPii";let o=e.getAttribute("data-trackers")?e.getAttribute("data-trackers"):["page"];o&&o.indexOf(",")>-1&&(o=o.split(",")),i&&t.beacon.init({log:s,apiRoot:i,identity:n,trackers:o})}}})(window)}();
