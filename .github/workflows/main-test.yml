name: Main Test
on:
  push:
    branches:
      - main
permissions:
  id-token: write
  contents: write
  checks: write
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '24.12.0'
          registry-url: https://npm.pkg.github.com/

      - name: Install and Build ğŸ”§
        run: |
          npm ci
          npm run build

      - name: Run Tests
        run: npm run test

      - name: Generate coverage endpoint files
        run: |
          mkdir -p .badges
          node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
          const total = coverage.total;
          
          function getColor(pct) {
            if (pct >= 80) return 'brightgreen';
            if (pct >= 60) return 'green';
            if (pct >= 40) return 'yellowgreen';
            if (pct >= 20) return 'yellow';
            return 'red';
          }
          
          function createEndpoint(label, pct) {
            return {
              schemaVersion: 1,
              label: label,
              message: pct.toFixed(2) + '%',
              color: getColor(pct)
            };
          }
          
          fs.writeFileSync('.badges/coverage-lines.json', JSON.stringify(createEndpoint('coverage lines', total.lines.pct)));
          fs.writeFileSync('.badges/coverage-functions.json', JSON.stringify(createEndpoint('coverage functions', total.functions.pct)));
          fs.writeFileSync('.badges/coverage-statements.json', JSON.stringify(createEndpoint('coverage statements', total.statements.pct)));
          fs.writeFileSync('.badges/coverage-total.json', JSON.stringify(createEndpoint('coverage', total.lines.pct)));
          "

      - name: Commit coverage files to badges branch
        run: |
          mkdir -p /tmp/coverage-badges
          cp coverage/coverage-summary.json /tmp/coverage-badges/
          cp -r .badges /tmp/coverage-badges/
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git fetch origin badges || true
          git reset --hard HEAD
          git clean -fd
          rm -rf .badges
          if git ls-remote --heads origin badges | grep -q badges; then
            git checkout -f badges 2>/dev/null || git checkout -f -b badges origin/badges
            git reset --hard origin/badges
          else
            git checkout -f --orphan badges
          fi
          mkdir -p coverage .badges
          cp /tmp/coverage-badges/coverage-summary.json coverage/
          cp /tmp/coverage-badges/.badges/* .badges/
          git add coverage/coverage-summary.json .badges/*.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: update coverage data [skip ci]"
            git push --force-with-lease origin badges
          fi
