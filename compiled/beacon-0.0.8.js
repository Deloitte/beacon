!function(){"use strict";function t(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;!function(t){var e=function(t){var e,n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,n){return t[e]=n}}function u(t,e,n,r){var i=e&&e.prototype instanceof v?e:v,s=Object.create(i.prototype),a=new L(r||[]);return o(s,"_invoke",{value:j(t,n,a)}),s}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var d="suspendedStart",g="suspendedYield",f="executing",p="completed",y={};function v(){}function b(){}function m(){}var w={};l(w,s,(function(){return this}));var k=Object.getPrototypeOf,S=k&&k(k(N([])));S&&S!==n&&r.call(S,s)&&(w=S);var E=m.prototype=v.prototype=Object.create(w);function x(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function O(t,e){function n(o,i,s,a){var c=h(t[o],t,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?e.resolve(u.__await).then((function(t){n("next",t,s,a)}),(function(t){n("throw",t,s,a)})):e.resolve(u).then((function(t){l.value=t,s(l)}),(function(t){return n("throw",t,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(t,r){function o(){return new e((function(e,o){n(t,r,e,o)}))}return i=i?i.then(o,o):o()}})}function j(t,n,r){var o=d;return function(i,s){if(o===f)throw new Error("Generator is already running");if(o===p){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=A(a,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===d)throw o=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=h(t,n,r);if("normal"===l.type){if(o=r.done?p:g,l.arg===y)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=p,r.method="throw",r.arg=l.arg)}}}function A(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,A(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var i=h(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,y;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function I(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function T(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(I,this),this.reset(!0)}function N(t){if(null!=t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(typeof t+" is not iterable")}return b.prototype=m,o(E,"constructor",{value:m,configurable:!0}),o(m,"constructor",{value:b,configurable:!0}),b.displayName=l(m,c,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,l(t,c,"GeneratorFunction")),t.prototype=Object.create(E),t},t.awrap=function(t){return{__await:t}},x(O.prototype),l(O.prototype,a,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new O(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},x(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},t.values=N,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),T(n),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}(t.exports);try{regeneratorRuntime=e}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}}({exports:{}});class e{constructor({name:t,isEnabled:e}){this.name=t,this.isEnabled=e,this.color=this.getColor(t)}getColor(t){var e=0;if(0===t.length)return"";for(var n=0;n<t.length;n++)e=t.charCodeAt(n)+((e<<5)-e),e|=0;var r="#";for(n=0;n<3;n++){r+=("00"+(e>>8*n&255).toString(16)).substr(-2)}return r.toString()}get enabled(){return this.isEnabled}set enabled(t){this.isEnabled=t}info(...t){const e=`color: ${this.color}; font-weight: bold;`;this.isEnabled&&console.info(`%c${this.name}\n`,e,...t)}important(t){const e=`color: ${this.color}; font-size: 24px; font-weight: bold;`;this.isEnabled&&(console.log(`%c${this.name}:`,"color: #999; font-size: 10px; font-weight: bold;"),console.log(`%c${t}`,e))}debug(...t){const e=`color: ${this.color}; font-weight: bold;`;this.isEnabled&&console.log(`%c${this.name}\n`,e,...t)}error(...t){console.error(`%c${this.name}\n`,"color: white; background: #ce1a43; font-weight: bold;",...t)}warn(...t){this.isEnabled&&console.warn(`%c${this.name}\n`,"color: white; background: #bf7506; font-weight: bold;",...t)}}class n{constructor(t,n,r){this.parent=t,this.core=n,this.logger=new e({name:r,isEnabled:!!this.core.config.log}),this.enabled=!0}track(t,e,n){this.logger.debug("track",{type:t,event:e,properties:n}),this.core?this.core.processActivity(t,e,n):this.logger.error("blueprint does not exist on window")}init(){return t(this,void 0,void 0,(function*(){yield this.autoTrack()}))}autoTrack(){return t(this,void 0,void 0,(function*(){}))}}const r=["title"],o=["entity"],i=["entity-id"],s=["entity-props"],a=["props"],c=["dataset","attributes","innerText"];function l(t){const e=Object.create(null);for(const[n,r]of t)e[n]=r;return e}function u(t,e,n){void 0!==t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,n)}function h(){const t=crypto.getRandomValues(new Uint16Array(8)),e=[].map.call(t,(t=>t.toString(16).padStart(4,"0"))).join(""),n=(t[5]>>12&3|8).toString(16);return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${n}${e.substr(17,3)}-${e.substr(20,12)}`}function d(){return Math.floor((new Date).getTime()/1e3)}function g(t,e){for(const n of t){const t=e.querySelector(`meta[name=${n}]`);if(t)return t.getAttribute("content")}}function f(t,e){const n=new Map;for(const r of t){const t=e.querySelector(`meta[name^=${r}]`);t&&n.set(t.name.replace(`${r}-`,""),t.getAttribute("content"))}return n}function p(t,e){if(e){const n=g(t.config.settings.page.eventName,e);return n||(e.title?e.title:"Page Viewed")}}function y(t,e){var n;const{document:r}=e;return l(f(null===(n=t.config.settings.page)||void 0===n?void 0:n.properties,r))}function v(t,e){var n,r,o;let i,s,a;if(i=g(null===(n=t.config.settings.page)||void 0===n?void 0:n.entity,e),i)return s=g(null===(r=t.config.settings.page)||void 0===r?void 0:r.entityId,e),a=f(null===(o=t.config.settings.page)||void 0===o?void 0:o.entityProps,e),{type:i,id:s,props:a?l(a):{}}}function b(t,e){if(e)return e.title?e.title:"Page Viewed"}class m extends n{constructor(t,e){super(t,e,"PageTracker"),this.waitForIt=()=>new Promise((t=>setTimeout(t,600)))}autoTrack(){return t(this,void 0,void 0,(function*(){yield this.waitForIt();const t={pageName:b(this.core,document),entity:v(this.core,document),properties:y(this.core,window)};this.track("page","PageViewed",Object.assign(Object.assign({page:t.pageName},t.properties),t.entity&&{entity:t.entity}))}))}}class w extends n{constructor(t,e){super(t,e,"ClickTracker")}trackClick(t,e){const n=e.target;if(n){let o,i={event:e,properties:{}};const s={pageName:p(this.core,document),entity:v(this.core,document),properties:y(this.core,window)},{x:a,y:l}=void 0!==(r=e).pageY&&void 0!==r.pageX?{x:r.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:r.clientY+document.body.scrollTop+document.documentElement.scrollTop}:{x:null,y:null};o=this.getMetaFromTrackedElement(t,c,n),i={event:o.event,properties:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s.properties),o.properties),s.pageName&&{page:s.pageName}),{location:{x:a,y:l}}),s.entity||o.entity&&{entity:Object.assign(Object.assign({},s.entity),o.entity)})},this.track("track",i.event,i.properties)}var r;return!1}getMetaFromTrackedElement(t,e,n){const r=`${t}Clicked`,o=Object.assign(Object.assign(Object.assign(Object.assign({},n.getAttribute("id")&&{id:n.getAttribute("id")}),n.getAttribute("class")&&{class:n.getAttribute("class")}),n.getAttribute("href")&&{href:n.getAttribute("href")}),n.innerText&&{inner_text:n.innerText});for(const t of e){const e=n[t];if(e&&"dataset"===t)return{event:r,entity:Object.assign(Object.assign({},e.entity&&{type:e.entity}),e.entityId&&{id:e.entityId}),properties:o}}return{event:r,entity:void 0,properties:{}}}autoTrack(){return t(this,void 0,void 0,(function*(){const t=document.querySelectorAll("a"),e=document.querySelectorAll("button");for(const e of t)u(e,"click",(t=>{this.trackClick("Link",t)}));for(const t of e)u(t,"click",(t=>{this.trackClick("Button",t)}))}))}}class k extends n{constructor(t,e){super(t,e,"FormTracker")}trackForm(t){t.preventDefault();const e=[],n=t.target;if(n){const t={pageName:p(this.core,document),entity:v(this.core,document),properties:y(this.core,window)},r=Object.assign(Object.assign({},n.getAttribute("id")&&{id:n.getAttribute("id")}),n.getAttribute("class")&&{class:n.getAttribute("class")});if(n.elements)for(const t of n.elements)t.id&&""!==t.id&&e.push({key:t.id,value:t.value});this.track("track","FormSubmitted",Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t.properties),r&&{form:r}),e&&{formValues:e}),t.pageName&&{page:t.pageName}),t.entity&&{entity:t.entity}))}return!1}autoTrack(){return t(this,void 0,void 0,(function*(){0===document.querySelectorAll("form").length&&(yield new Promise((t=>setTimeout(t,2e3))));const t=document.querySelectorAll("form");for(const e of t)u(e,"submit",(t=>{this.trackForm(t)}))}))}}class S{constructor(t,e,n){this.config=t,this.core=e,this.parent=n}init(){}createTracker(t){return"page"===t?new m(this.parent,this.core):"click"===t?new w(this.parent,this.core):"form"===t?new k(this.parent,this.core):void 0}}class E{constructor(){this.localStorageSupported="undefined"!=typeof window}set(t,e){this.localStorageSupported&&localStorage.setItem(t,e)}get(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e||null}return null}setJson(t,e){this.localStorageSupported&&localStorage.setItem(t,JSON.stringify(e))}getJson(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e?JSON.parse(e):void 0}}remove(t){this.localStorageSupported&&localStorage.removeItem(t)}clear(){this.localStorageSupported&&localStorage.clear()}}class x{constructor(t,n){this.config=t,this.core=n,this.logger=new e({name:"SessionController",isEnabled:!(!this.config.log||!this.config.settings.session.log)})}init(){return t(this,void 0,void 0,(function*(){const t=new E,e=yield t.getJson(this.config.settings.session.storeName);if(e){const t=d();t-e.lastEvent>=this.config.settings.session.duration?(this.logger.debug("Session timeout exceeded, starting new session"),yield this.startSession(e)):(this.logger.debug(`Session active and not timed out, extending session ${e.sessionId}`),this.extendSession(Object.assign(Object.assign({},e),{lastEvent:t})))}else this.logger.debug("No active session"),yield this.startSession()}))}trackSessionEnd(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionEnded",e))}))}trackSessionStart(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionStarted",e))}))}startSession(){return t(this,arguments,void 0,(function*(t=void 0){const e=d();t&&(yield this.trackSessionEnd(t)),this.sessionId=h();const n={sessionId:this.sessionId,firstEvent:e,lastEvent:e};yield(new E).setJson(this.config.settings.session.storeName,n),yield this.trackSessionStart(n)}))}extendSession(e){return t(this,void 0,void 0,(function*(){this.sessionId=e.sessionId,yield(new E).setJson(this.config.settings.session.storeName,e)}))}}class O{constructor(t,n){this.config=t,this.core=n,this.logger=new e({name:"UserController",isEnabled:!(!this.config.log||!this.config.settings.user.log)})}seedAnonymous(e){return t(this,void 0,void 0,(function*(){this.logger.debug("Seeding anonymous identity"),this.userId=h();const t={id:this.userId,type:"anonymous"};this.config.settings.user.trackEvents&&(yield this.core.processActivity("identity","anonymous",t)),yield e.setJson(this.config.settings.user.storeName,t)}))}attemptIdentity(e){return t(this,void 0,void 0,(function*(){this.config.settings.user.seedAnonymous&&(yield this.seedAnonymous(e))}))}init(){return t(this,void 0,void 0,(function*(){const t=new E,e=yield t.getJson(this.config.settings.user.storeName);e?(this.userId=e.id,this.logger.debug(`identity is set as ${this.userId}`)):yield this.attemptIdentity(t)}))}}function j(t,e){switch(e){case"userAndSession":t.user.enabled=!0,t.session.enabled=!0;break;case"user":t.user.enabled=!0,t.session.enabled=!1;break;case"session":t.user.enabled=!1,t.session.enabled=!0;break;case"noPii":t.user.enabled=!1,t.session.enabled=!1}return t}class A{constructor(t,n=[]){var c;this.loaded=!1,this.enabled=!1,this.window=t,this.trackers=new Map,this.config={log:!1,identity:"noPii",apiRoot:"http://localhost",settings:(c="noPii",j({transport:{apiRoute:"/api/activity",method:"sendBeacon"},queue:{store:"localStorage",storeName:"bp-queue"},page:{eventName:r,entity:o,entityId:i,entityProps:s,properties:a},user:{log:!0,enabled:!1,seedAnonymous:!0,trackEvents:!0,storeType:"localStorage",storeName:"bp-user"},session:{log:!0,enabled:!1,trackEvents:!0,storeType:"localStorage",storeName:"bp-session",duration:300}},c)),trackers:[]},this.logger=new e({name:"Core",isEnabled:!0}),this.logger.debug("version 0.0.8, built on March 9, 2024 15:18:55"),this.sessionController=new x(this.config,this),this.userController=new O(this.config,this)}getConfig(){return this.config}init(e){return t(this,void 0,void 0,(function*(){var n;if(e&&(null===(n=this.logger)||void 0===n||n.debug("config loaded",e),this.applyConfig(e)),this.config.settings.user.enabled&&(yield this.userController.init()),this.config.settings.session.enabled&&(yield this.sessionController.init()),this.config){const e=new S(this.config,this,this.window);for(const t of this.config.trackers){if(void 0===t)return;const n=e.createTracker(t);n&&this.trackers.set(t,n)}this.trackers.forEach((e=>t(this,void 0,void 0,(function*(){yield e.init()}))))}this.loaded=!0}))}applyConfig(t){this.config=Object.assign(Object.assign({},this.config),t),this.config.settings=j(this.config.settings,this.config.identity),this.enabled=!0}track(t,e,n){this.processActivity(t,e,n)}trackCurrentPage(){const t=this.trackers.get("page");t&&t.autoTrack()}autoTrack(){this.trackers.forEach((t=>{t.autoTrack()}))}processIdentity(e,n){return t(this,arguments,void 0,(function*(t,e,n={}){console.log(t,e,n)}))}processActivity(e,n,r){return t(this,void 0,void 0,(function*(){var t;const{screen:{width:o,height:i},navigator:{language:s,userAgent:a},location:{hostname:c,pathname:l,search:u},document:h}=window;let d={screen:`${o}x${i}`,language:s,userAgent:a,url:`${l}${u}`,referrer:h.referrer,hostname:c};this.userController&&this.userController.userId&&(d=Object.assign({userId:this.userController.userId},d)),this.sessionController&&this.sessionController.sessionId&&(d=Object.assign({sessionId:this.sessionController.sessionId},d));const g={type:e,event:n,properties:r,context:d,originalTimestamp:(new Date).toISOString()};null===(t=this.logger)||void 0===t||t.debug("sendToApi",g),yield this.sendActivity(g)}))}sendActivity(e){return t(this,void 0,void 0,(function*(){if("sendBeacon"===this.config.settings.transport.method){const t=new Blob([JSON.stringify(e)]);navigator.sendBeacon(`${this.config.apiRoot}${this.config.settings.transport.apiRoute}`,t)}}))}}(e=>{let n;if(e._beacon?(n=new A(e,e._beacon.queue),e._beacon=n):(e._beacon={loaded:!1,queue:e.beacon},n=new A(e),e._beacon=n,e.beacon=n),e._beacon.call=function(e,r){return t(this,arguments,void 0,(function*(t,e,r={},o={}){switch(t){case"init":n.init(e);break;case"track":case"page":case"click":case"form":case"dataLayer":yield n.track(t,e,r);break;case"trackCurrentPage":yield n.trackCurrentPage();break;case"identify":case"identity":case"trait":case"traits":yield n.processIdentity({type:t,data:{event:e,properties:r,context:o}});break;case"clear":yield n.clear()}}))},e._beacon.queue){for(const t of e._beacon.queue)e._beacon.call(t[0],t[1],t[2]?t[2]:{},t[3]?t[3]:{});e._beacon.queue=[]}})(window)}();
