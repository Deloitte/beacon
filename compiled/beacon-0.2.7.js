!function(){"use strict";function t(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}c((i=i.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class e{constructor({name:t,isEnabled:e}){this.name=t,this.isEnabled=e,this.color=this.getColor(t)}getColor(t){let e=0;if(0===t.length)return"";for(let s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e),e|=0;let s="#";for(let t=0;t<3;t++){s+=("00"+(e>>8*t&255).toString(16)).substr(-2)}return s.toString()}info(...t){const e=`color: ${this.color}; font-weight: bold;`;this.isEnabled&&console.info(`%c${this.name}\n`,e,...t)}debug(...t){this.isEnabled&&console.log(`%c${this.name}\n`,`color: ${this.color}; font-weight: bold;`,...t)}error(...t){this.isEnabled&&console.error(`%c${this.name}\n`,"color: white; background: #ce1a43; font-weight: bold;",...t)}warn(...t){this.isEnabled&&console.warn(`%c${this.name}\n`,"color: white; background: #bf7506; font-weight: bold;",...t)}}function s(t){const e=Object.create(null);for(const[s,i]of t)e[s]=i;return e}function i(t,e,s){t.addEventListener(e,s,!1)}function n(){const t=crypto.getRandomValues(new Uint16Array(8)),e=[].map.call(t,(t=>t.toString(16).padStart(4,"0"))).join(""),s=(t[5]>>12&3|8).toString(16);return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${s}${e.substr(17,3)}-${e.substr(20,12)}`}function o(){return Math.floor((new Date).getTime()/1e3)}class r{constructor(){this.localStorageSupported="undefined"!=typeof window}set(t,e){this.localStorageSupported&&localStorage.setItem(t,e)}get(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e||null}return null}setJson(t,e){this.localStorageSupported&&localStorage.setItem(t,JSON.stringify(e))}getJson(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e?JSON.parse(e):void 0}}remove(t){this.localStorageSupported&&localStorage.removeItem(t)}clear(){this.localStorageSupported&&localStorage.clear()}}class a{constructor(t,s){this.config=t,this.core=s,this.logger=new e({name:"SessionController",isEnabled:this.config.log&&this.config.settings.session.log})}init(){return t(this,void 0,void 0,(function*(){const t=new r;if(this.session=yield t.getJson(this.config.settings.session.storeName),this.session){const t=o();t-this.session.lastEvent>=this.config.settings.session.duration?(this.logger.debug("Session timeout exceeded, starting new session"),yield this.startSession(this.session)):(this.logger.debug(`Session active and not timed out, extending session ${this.session.sessionId}`),this.extendSession(Object.assign(Object.assign({},this.session),{lastEvent:t})))}else this.logger.debug("No active session"),yield this.startSession()}))}trackSessionEnd(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionEnded",e))}))}trackSessionStart(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionStarted",e))}))}startSession(){return t(this,arguments,void 0,(function*(t=void 0){const e=o();t&&(yield this.trackSessionEnd(t)),this.sessionId=n();const s={sessionId:this.sessionId,firstEvent:e,lastEvent:e};yield(new r).setJson(this.config.settings.session.storeName,s),yield this.trackSessionStart(s)}))}extendSession(e){return t(this,void 0,void 0,(function*(){this.sessionId=e.sessionId,yield(new r).setJson(this.config.settings.session.storeName,e)}))}}class c{constructor(t,s){this.config=t,this.core=s,this.logger=new e({name:"UserController",isEnabled:this.config.log&&this.config.settings.user.log})}seedAnonymous(e){return t(this,void 0,void 0,(function*(){this.logger.debug("Seeding anonymous identity"),this.userId=n();const t={id:this.userId,type:"anonymous"};this.config.settings.user.trackEvents&&(yield this.core.processActivity("identity","anonymous",t)),yield e.setJson(this.config.settings.user.storeName,t)}))}attemptIdentity(e){return t(this,void 0,void 0,(function*(){this.config.settings.user.seedAnonymous&&(yield this.seedAnonymous(e))}))}init(){return t(this,void 0,void 0,(function*(){const t=new r,e=yield t.getJson(this.config.settings.user.storeName);e?(this.userId=e.id,this.logger.debug(`identity is set as ${this.userId}`)):yield this.attemptIdentity(t)}))}}const l=["title"],d=["entity"],g=["entity-id"],h=["entity-props"],u=["props"];function p(t,e){switch(e){case"userAndSession":t.user.enabled=!0,t.session.enabled=!0;break;case"user":t.user.enabled=!0,t.session.enabled=!1;break;case"session":t.user.enabled=!1,t.session.enabled=!0;break;case"noPii":t.user.enabled=!1,t.session.enabled=!1}return t}class f{constructor(t,s,i){this.parent=t,this.core=s,this.logger=new e({name:i,isEnabled:this.core.config.log}),this.enabled=!0}sendTrack(t,e,s){this.logger.debug("track",{type:t,event:e,properties:s}),this.core&&this.core.processActivity(t,e,s)}}function m(t,e){for(const s of t){const t=e.querySelector(`meta[name=${s}]`);if(t)return t.getAttribute("content")}}function y(t,e){const s=new Map;for(const i of t){const t=e.querySelector(`meta[name^=${i}]`);t&&s.set(t.name.replace(`${i}-`,""),t.getAttribute("content"))}return s}function b(t,e){return e.title?e.title:"PageViewed"}function v(t,e){const{document:i}=e;return s(y(t.config.settings.page.properties,i))}function w(t,e){var i;let n,o,r;if(n=m(null===(i=t.config.settings.page)||void 0===i?void 0:i.entity,e),n)return o=m(t.config.settings.page.entityId,e),r=y(t.config.settings.page.entityProps,e),{type:n,id:o,props:r?s(r):{}}}class k extends f{constructor(t,e){super(t,e,"PageTracker"),this.waitForIt=()=>new Promise((t=>setTimeout(t,600)))}init(){return t(this,void 0,void 0,(function*(){yield this.waitForIt(),yield this.handleStates(),yield this.track()}))}handleStates(){return t(this,void 0,void 0,(function*(){const e=history.pushState;history.pushState=function(...t){const s=e.apply(this,t);return window.dispatchEvent(new Event("pushstate")),window.dispatchEvent(new Event("locationchange")),s};const s=history.replaceState;history.replaceState=function(...t){const e=s.apply(this,t);return window.dispatchEvent(new Event("replacestate")),window.dispatchEvent(new Event("locationchange")),e},window.addEventListener("popstate",(function(){window.dispatchEvent(new Event("locationchange"))})),window.addEventListener("locationchange",(()=>t(this,void 0,void 0,(function*(){yield this.waitForIt(),yield this.track()}))),!1)}))}track(){return t(this,void 0,void 0,(function*(){const t={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)};this.sendTrack("page","PageViewed",Object.assign(Object.assign({page:t.pageName},t.properties),t.entity&&{entity:t.entity}))}))}}class S extends f{constructor(t,e){super(t,e,"ClickTracker")}init(){return t(this,void 0,void 0,(function*(){i(parent,"click",(t=>{this.track(t)}))}))}getElementNameByTagName(t){return"A"===t?"Link":"BUTTON"===t?"Button":"DIV"===t?"Div":"FORM"===t?"Form":"INPUT"===t?"Input":"Element"}track(t,e={}){if(t){const i=t.target;if(i){let n,o={event:t,properties:e};const r={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)},{x:a,y:c}=void 0!==(s=t).pageY&&void 0!==s.pageX?{x:s.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:s.clientY+document.body.scrollTop+document.documentElement.scrollTop}:{x:null,y:null};n=this.getMetaFromTrackedElement(this.getElementNameByTagName(i.tagName),i),o={event:n.event,properties:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},r.properties),n.properties),r.pageName&&{page:r.pageName}),{location:{x:a,y:c}}),r.entity||n.entity&&{entity:Object.assign(Object.assign({},r.entity),n.entity)})},this.sendTrack("track",o.event,o.properties)}}var s;return!1}getMetaFromTrackedElement(t,e){let s=`${t}Clicked`;const i={},n={};if(i.element=e.tagName.toLowerCase(),e.hasAttributes())for(const t of e.attributes)t.name.startsWith("data-")?("data-event"===t.name&&(s=t.value),"data-entity"===t.name&&(n.type=t.value),"data-entity-id"===t.name&&(n.id=t.value)):i[t.name]=t.value;return e.innerText&&(i.inner_text=e.innerText),e.textContent&&(i.textContent=e.textContent),{event:s,entity:n,properties:i}}}class E extends f{constructor(t,e){super(t,e,"FormTracker")}init(){return t(this,void 0,void 0,(function*(){0===document.querySelectorAll("form").length&&(yield new Promise((t=>setTimeout(t,2e3))));const t=document.querySelectorAll("form");for(const e of t)i(e,"submit",(t=>{this.track(t)}))}))}track(t){if(t){t.preventDefault();const e=[],s=t.target;if(s){const t={pageName:b(this.core,document),entity:w(this.core,document),properties:v(this.core,window)},i=Object.assign(Object.assign({},s.getAttribute("id")&&{id:s.getAttribute("id")}),s.getAttribute("class")&&{class:s.getAttribute("class")});if(s.elements)for(const t of s.elements)t.id&&""!==t.id&&e.push({key:t.id,value:t.value});this.sendTrack("track","FormSubmitted",Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t.properties),i&&{form:i}),e&&{formValues:e}),t.pageName&&{page:t.pageName}),t.entity&&{entity:t.entity}))}}return!1}}let A;class I{constructor(t,s=[]){var i;A=this,this.loaded=!1,this.enabled=!1,this.window=t,this.trackers=new Map,this.config={log:!1,identity:"noPii",apiRoot:"http://localhost",settings:(i="noPii",p({transport:{apiRoute:"/api/activity",method:"sendBeacon"},queue:{store:"localStorage",storeName:"beacon-queue"},page:{eventName:l,entity:d,entityId:g,entityProps:h,properties:u},user:{log:!0,enabled:!1,seedAnonymous:!0,trackEvents:!0,storeType:"localStorage",storeName:"beacon-user"},session:{log:!0,enabled:!1,trackEvents:!0,storeType:"localStorage",storeName:"beacon-session",duration:300}},i)),trackers:[]},this.logger=new e({name:"Core",isEnabled:!1}),this.sessionController=new a(this.config,this),this.userController=new c(this.config,this)}getConfig(){return this.config}registerTrackers(){return t(this,void 0,void 0,(function*(){for(const t of this.config.trackers)switch(t){case"page":this.trackers.set("page",new k(this.window,this));break;case"click":this.trackers.set("click",new S(this.window,this));break;case"form":this.trackers.set("form",new E(this.window,this));break;default:this.logger.warn(`Tracker ${t} doesnt exist and cannot be registered`)}this.trackers.forEach((e=>t(this,void 0,void 0,(function*(){e.init&&(yield e.init())}))))}))}init(e){return t(this,void 0,void 0,(function*(){e&&this.applyConfig(e),this.config.settings.user.enabled&&(yield this.userController.init()),this.config.settings.session.enabled&&(yield this.sessionController.init()),yield this.registerTrackers(),this.loaded=!0}))}mergeConfig(t,e){return Object.keys(e).forEach((s=>{!t.hasOwnProperty(s)||"object"!=typeof t[s]||t[s]instanceof Array?t[s]=e[s]:this.mergeConfig(t[s],e[s])})),t}applyConfig(t){this.mergeConfig(this.config,t),this.logger.isEnabled=this.config.log,this.logger.debug("config loaded",t),this.logger.debug("version 0.2.7, built on May 28, 2024 17:43:29"),this.config.settings=p(this.config.settings,this.config.identity),this.config.apiRoot.endsWith("/")&&(this.config.apiRoot=this.config.apiRoot.slice(0,-1)),this.enabled=!0}track(t,e,s){if("track"===t||"event"===t)this.processActivity(t,e,s);else if("click"===t){let e=this.trackers.get(t);e||(e=new S(this.window,this))}else if("page"===t){let e=this.trackers.get(t);e||(e=new k(this.window,this)),e.track()}else if("form"===t){const e=this.trackers.get(t);(null==e?void 0:e.track)&&e.track()}else this.logger.warn(`track type of ${t} doesn't exist`)}trackClick(t){A.track("click","Link",t)}trackButtonClick(t){A.track("click","Button",t)}trackCurrentPage(){A.track("page","PageViewed",{})}autoTrack(){this.trackers.forEach((t=>{t.track&&t.track()}))}processActivity(e,s,i){return t(this,void 0,void 0,(function*(){const{screen:{width:t,height:n},navigator:{language:o,userAgent:r},location:{hostname:a,pathname:c,search:l},document:d}=window;let g={channel:"web",screen:`${t}x${n}`,language:o,userAgent:r,url:`${c}${l}`,referrer:d.referrer,hostname:a};this.userController&&this.userController.userId&&(g=Object.assign({userId:this.userController.userId},g)),this.sessionController&&this.sessionController.sessionId&&(g=Object.assign({sessionId:this.sessionController.sessionId},g));const h={type:e,event:s,properties:i,context:g,originalTimestamp:(new Date).toISOString()};this.logger.debug("sendToApi",h),yield this.sendActivity(h)}))}sendActivity(e){return t(this,void 0,void 0,(function*(){if("sendBeacon"===this.config.settings.transport.method){const t=new Blob([JSON.stringify(e)]);navigator.sendBeacon(`${this.config.apiRoot}${this.config.settings.transport.apiRoute}`,t)}}))}}(t=>{if(!t.beacon){t.beacon=new I(t);const e=document.getElementById("beaconScript");if(e){const s=e.getAttribute("data-api-root"),i="true"===e.getAttribute("data-log"),n=e.getAttribute("data-identity")?e.getAttribute("data-identity"):"noPii";let o=e.getAttribute("data-trackers")?e.getAttribute("data-trackers"):["page"];o&&o.indexOf(",")>-1&&(o=o.split(",")),s&&t.beacon.init({log:i,apiRoot:s,identity:n,trackers:o})}}})(window)}();
