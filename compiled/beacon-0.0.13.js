!function(){"use strict";function t(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;!function(t){var e=function(t){var e,n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function l(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,n){return t[e]=n}}function u(t,e,n,r){var o=e&&e.prototype instanceof v?e:v,s=Object.create(o.prototype),a=new T(r||[]);return i(s,"_invoke",{value:j(t,n,a)}),s}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var d="suspendedStart",g="suspendedYield",f="executing",p="completed",y={};function v(){}function m(){}function b(){}var w={};l(w,s,(function(){return this}));var k=Object.getPrototypeOf,S=k&&k(k(N([])));S&&S!==n&&r.call(S,s)&&(w=S);var E=b.prototype=v.prototype=Object.create(w);function x(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function O(t,e){function n(i,o,s,a){var c=h(t[i],t,o);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?e.resolve(u.__await).then((function(t){n("next",t,s,a)}),(function(t){n("throw",t,s,a)})):e.resolve(u).then((function(t){l.value=t,s(l)}),(function(t){return n("throw",t,s,a)}))}a(c.arg)}var o;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return o=o?o.then(i,i):i()}})}function j(t,n,r){var i=d;return function(o,s){if(i===f)throw new Error("Generator is already running");if(i===p){if("throw"===o)throw s;return{value:e,done:!0}}for(r.method=o,r.arg=s;;){var a=r.delegate;if(a){var c=A(a,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===d)throw i=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=f;var l=h(t,n,r);if("normal"===l.type){if(i=r.done?p:g,l.arg===y)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=p,r.method="throw",r.arg=l.arg)}}}function A(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,A(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var o=h(i,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,y;var s=o.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,y):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,y)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function I(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function N(t){if(null!=t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,o=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return m.prototype=b,i(E,"constructor",{value:b,configurable:!0}),i(b,"constructor",{value:m,configurable:!0}),m.displayName=l(b,c,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===m||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,l(t,c,"GeneratorFunction")),t.prototype=Object.create(E),t},t.awrap=function(t){return{__await:t}},x(O.prototype),l(O.prototype,a,(function(){return this})),t.AsyncIterator=O,t.async=function(e,n,r,i,o){void 0===o&&(o=Promise);var s=new O(u(e,n,r,i),o);return t.isGeneratorFunction(n)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},x(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},t.values=N,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(I),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return a.type="throw",a.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=t,s.arg=e,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),I(n),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;I(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}(t.exports);try{regeneratorRuntime=e}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}}({exports:{}});class e{constructor({name:t,isEnabled:e}){this.name=t,this.isEnabled=e,this.color=this.getColor(t)}getColor(t){let e=0;if(0===t.length)return"";for(let n=0;n<t.length;n++)e=t.charCodeAt(n)+((e<<5)-e),e|=0;let n="#";for(let t=0;t<3;t++){n+=("00"+(e>>8*t&255).toString(16)).substr(-2)}return n.toString()}info(...t){const e=`color: ${this.color}; font-weight: bold;`;this.isEnabled&&console.info(`%c${this.name}\n`,e,...t)}debug(...t){this.isEnabled&&console.log(`%c${this.name}\n`,`color: ${this.color}; font-weight: bold;`,...t)}error(...t){this.isEnabled&&console.error(`%c${this.name}\n`,"color: white; background: #ce1a43; font-weight: bold;",...t)}warn(...t){this.isEnabled&&console.warn(`%c${this.name}\n`,"color: white; background: #bf7506; font-weight: bold;",...t)}}function n(t){const e=Object.create(null);for(const[n,r]of t)e[n]=r;return e}function r(t,e,n){t.addEventListener(e,n,!1)}function i(){const t=crypto.getRandomValues(new Uint16Array(8)),e=[].map.call(t,(t=>t.toString(16).padStart(4,"0"))).join(""),n=(t[5]>>12&3|8).toString(16);return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${n}${e.substr(17,3)}-${e.substr(20,12)}`}function o(){return Math.floor((new Date).getTime()/1e3)}class s{constructor(){this.localStorageSupported="undefined"!=typeof window}set(t,e){this.localStorageSupported&&localStorage.setItem(t,e)}get(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e||null}return null}setJson(t,e){this.localStorageSupported&&localStorage.setItem(t,JSON.stringify(e))}getJson(t){if(this.localStorageSupported){const e=localStorage.getItem(t);return e?JSON.parse(e):void 0}}remove(t){this.localStorageSupported&&localStorage.removeItem(t)}clear(){this.localStorageSupported&&localStorage.clear()}}class a{constructor(t,n){this.config=t,this.core=n,this.logger=new e({name:"SessionController",isEnabled:this.config.log&&this.config.settings.session.log})}init(){return t(this,void 0,void 0,(function*(){const t=new s;if(this.session=yield t.getJson(this.config.settings.session.storeName),this.session){const t=o();t-this.session.lastEvent>=this.config.settings.session.duration?(this.logger.debug("Session timeout exceeded, starting new session"),yield this.startSession(this.session)):(this.logger.debug(`Session active and not timed out, extending session ${this.session.sessionId}`),this.extendSession(Object.assign(Object.assign({},this.session),{lastEvent:t})))}else this.logger.debug("No active session"),yield this.startSession()}))}trackSessionEnd(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionEnded",e))}))}trackSessionStart(e){return t(this,void 0,void 0,(function*(){this.config.settings.session.trackEvents&&(yield this.core.processActivity("session","SessionStarted",e))}))}startSession(){return t(this,arguments,void 0,(function*(t=void 0){const e=o();t&&(yield this.trackSessionEnd(t)),this.sessionId=i();const n={sessionId:this.sessionId,firstEvent:e,lastEvent:e};yield(new s).setJson(this.config.settings.session.storeName,n),yield this.trackSessionStart(n)}))}extendSession(e){return t(this,void 0,void 0,(function*(){this.sessionId=e.sessionId,yield(new s).setJson(this.config.settings.session.storeName,e)}))}}class c{constructor(t,n){this.config=t,this.core=n,this.logger=new e({name:"UserController",isEnabled:this.config.log&&this.config.settings.user.log})}seedAnonymous(e){return t(this,void 0,void 0,(function*(){this.logger.debug("Seeding anonymous identity"),this.userId=i();const t={id:this.userId,type:"anonymous"};this.config.settings.user.trackEvents&&(yield this.core.processActivity("identity","anonymous",t)),yield e.setJson(this.config.settings.user.storeName,t)}))}attemptIdentity(e){return t(this,void 0,void 0,(function*(){this.config.settings.user.seedAnonymous&&(yield this.seedAnonymous(e))}))}init(){return t(this,void 0,void 0,(function*(){const t=new s,e=yield t.getJson(this.config.settings.user.storeName);e?(this.userId=e.id,this.logger.debug(`identity is set as ${this.userId}`)):yield this.attemptIdentity(t)}))}}const l=["title"],u=["entity"],h=["entity-id"],d=["entity-props"],g=["props"],f=["dataset","attributes","innerText"];function p(t,e){switch(e){case"userAndSession":t.user.enabled=!0,t.session.enabled=!0;break;case"user":t.user.enabled=!0,t.session.enabled=!1;break;case"session":t.user.enabled=!1,t.session.enabled=!0;break;case"noPii":t.user.enabled=!1,t.session.enabled=!1}return t}class y{constructor(t,n,r){this.parent=t,this.core=n,this.logger=new e({name:r,isEnabled:this.core.config.log}),this.enabled=!0}sendTrack(t,e,n){this.logger.debug("track",{type:t,event:e,properties:n}),this.core&&this.core.processActivity(t,e,n)}}function v(t,e){for(const n of t){const t=e.querySelector(`meta[name=${n}]`);if(t)return t.getAttribute("content")}}function m(t,e){const n=new Map;for(const r of t){const t=e.querySelector(`meta[name^=${r}]`);t&&n.set(t.name.replace(`${r}-`,""),t.getAttribute("content"))}return n}function b(t,e){return e.title?e.title:"PageViewed"}function w(t,e){const{document:r}=e;return n(m(t.config.settings.page.properties,r))}function k(t,e){var r;let i,o,s;if(i=v(null===(r=t.config.settings.page)||void 0===r?void 0:r.entity,e),i)return o=v(t.config.settings.page.entityId,e),s=m(t.config.settings.page.entityProps,e),{type:i,id:o,props:s?n(s):{}}}class S extends y{constructor(t,e){super(t,e,"PageTracker"),this.waitForIt=()=>new Promise((t=>setTimeout(t,600)))}init(){return t(this,void 0,void 0,(function*(){yield this.track()}))}track(){return t(this,void 0,void 0,(function*(){yield this.waitForIt();const t={pageName:b(this.core,document),entity:k(this.core,document),properties:w(this.core,window)};this.sendTrack("page","PageViewed",Object.assign(Object.assign({page:t.pageName},t.properties),t.entity&&{entity:t.entity}))}))}}class E extends y{constructor(t,e){super(t,e,"ClickTracker")}init(){return t(this,void 0,void 0,(function*(){const t=document.querySelectorAll("a"),e=document.querySelectorAll("button");for(const e of t)r(e,"click",(t=>{this.track("Link",t)}));for(const t of e)r(t,"click",(t=>{this.track("Button",t)}))}))}track(t="Link",e){if(e){const r=e.target;if(r){let i,o={event:e,properties:{}};const s={pageName:b(this.core,document),entity:k(this.core,document),properties:w(this.core,window)},{x:a,y:c}=void 0!==(n=e).pageY&&void 0!==n.pageX?{x:n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:n.clientY+document.body.scrollTop+document.documentElement.scrollTop}:{x:null,y:null};i=this.getMetaFromTrackedElement(t,f,r),o={event:i.event,properties:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},s.properties),i.properties),s.pageName&&{page:s.pageName}),{location:{x:a,y:c}}),s.entity||i.entity&&{entity:Object.assign(Object.assign({},s.entity),i.entity)})},this.sendTrack("track",o.event,o.properties)}}var n;return!1}getMetaFromTrackedElement(t,e,n){const r=`${t}Clicked`,i=Object.assign(Object.assign(Object.assign(Object.assign({},n.getAttribute("id")&&{id:n.getAttribute("id")}),n.getAttribute("class")&&{class:n.getAttribute("class")}),n.getAttribute("href")&&{href:n.getAttribute("href")}),n.innerText&&{inner_text:n.innerText});for(const t of e){const e=n[t];if(e&&"dataset"===t)return{event:r,entity:Object.assign(Object.assign({},e.entity&&{type:e.entity}),e.entityId&&{id:e.entityId}),properties:i}}return{event:r,entity:void 0,properties:{}}}}class x extends y{constructor(t,e){super(t,e,"FormTracker")}init(){return t(this,void 0,void 0,(function*(){0===document.querySelectorAll("form").length&&(yield new Promise((t=>setTimeout(t,2e3))));const t=document.querySelectorAll("form");for(const e of t)r(e,"submit",(t=>{this.track(t)}))}))}track(t){if(t){t.preventDefault();const e=[],n=t.target;if(n){const t={pageName:b(this.core,document),entity:k(this.core,document),properties:w(this.core,window)},r=Object.assign(Object.assign({},n.getAttribute("id")&&{id:n.getAttribute("id")}),n.getAttribute("class")&&{class:n.getAttribute("class")});if(n.elements)for(const t of n.elements)t.id&&""!==t.id&&e.push({key:t.id,value:t.value});this.sendTrack("track","FormSubmitted",Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t.properties),r&&{form:r}),e&&{formValues:e}),t.pageName&&{page:t.pageName}),t.entity&&{entity:t.entity}))}}return!1}}class O{constructor(t,n=[]){var r;this.loaded=!1,this.enabled=!1,this.window=t,this.trackers=new Map,this.config={log:!1,identity:"noPii",apiRoot:"http://localhost",settings:(r="noPii",p({transport:{apiRoute:"/api/activity",method:"sendBeacon"},queue:{store:"localStorage",storeName:"bp-queue"},page:{eventName:l,entity:u,entityId:h,entityProps:d,properties:g},user:{log:!0,enabled:!1,seedAnonymous:!0,trackEvents:!0,storeType:"localStorage",storeName:"bp-user"},session:{log:!0,enabled:!1,trackEvents:!0,storeType:"localStorage",storeName:"bp-session",duration:300}},r)),trackers:[]},this.logger=new e({name:"Core",isEnabled:!0}),this.logger.debug("version 0.0.13, built on March 11, 2024 12:41:59"),this.sessionController=new a(this.config,this),this.userController=new c(this.config,this)}getConfig(){return this.config}registerTrackers(){return t(this,void 0,void 0,(function*(){for(const e of this.config.trackers){switch(e){case"page":this.trackers.set("page",new S(this.window,this));break;case"click":this.trackers.set("click",new E(this.window,this));break;case"form":this.trackers.set("form",new x(this.window,this));break;default:this.logger.warn(`Tracker ${e} doesnt exist and cannot be registered`)}this.trackers.forEach((e=>t(this,void 0,void 0,(function*(){e.init&&(yield e.init())}))))}}))}init(e){return t(this,void 0,void 0,(function*(){e&&(this.logger.debug("config loaded",e),this.applyConfig(e)),this.config.settings.user.enabled&&(yield this.userController.init()),this.config.settings.session.enabled&&(yield this.sessionController.init()),yield this.registerTrackers(),this.loaded=!0}))}applyConfig(t){this.config=Object.assign(Object.assign({},this.config),t),this.config.settings=p(this.config.settings,this.config.identity),this.enabled=!0}track(t,e,n){if(this.logger.error(t,e,n),"track"===t)this.processActivity(t,e,n);else if("event"===t)this.processActivity(t,e,n);else if("click"===t){const e=this.trackers.get(t);(null==e?void 0:e.track)&&e.track("Link",void 0)}else if("page"===t){const e=this.trackers.get(t);(null==e?void 0:e.track)&&e.track()}else if("form"===t){const e=this.trackers.get(t);(null==e?void 0:e.track)&&e.track()}else this.logger.warn(`track type of ${t} doesn't exist`)}trackCurrentPage(){const t=this.trackers.get("page");t&&t.track&&t.track()}autoTrack(){this.trackers.forEach((t=>{t.track&&t.track()}))}processActivity(e,n,r){return t(this,void 0,void 0,(function*(){const{screen:{width:t,height:i},navigator:{language:o,userAgent:s},location:{hostname:a,pathname:c,search:l},document:u}=window;let h={screen:`${t}x${i}`,language:o,userAgent:s,url:`${c}${l}`,referrer:u.referrer,hostname:a};this.userController&&this.userController.userId&&(h=Object.assign({userId:this.userController.userId},h)),this.sessionController&&this.sessionController.sessionId&&(h=Object.assign({sessionId:this.sessionController.sessionId},h));const d={type:e,event:n,properties:r,context:h,originalTimestamp:(new Date).toISOString()};this.logger.debug("sendToApi",d),yield this.sendActivity(d)}))}sendActivity(e){return t(this,void 0,void 0,(function*(){if("sendBeacon"===this.config.settings.transport.method){const t=new Blob([JSON.stringify(e)]);navigator.sendBeacon(`${this.config.apiRoot}${this.config.settings.transport.apiRoute}`,t)}}))}}(e=>{let n;e._beacon||(e._beacon={loaded:!1,queue:e.beacon},n=new O(e),e._beacon=n,e.beacon=n),e._beacon.call=function(e,r){return t(this,arguments,void 0,(function*(t,e,r={},i={}){switch(t){case"init":n.init(e);break;case"track":case"page":case"click":case"form":case"dataLayer":yield n.track(t,e,r);break;case"trackCurrentPage":yield n.trackCurrentPage()}}))}})(window)}();
