(function(){"use strict";function __awaiter(e,t,s,i){function adopt(e){return e instanceof s?e:new s((function(t){t(e)}))}return new(s||(s=Promise))((function(s,n){function fulfilled(e){try{step(i.next(e))}catch(e){n(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){n(e)}}function step(e){e.done?s(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))}typeof SuppressedError==="function"?SuppressedError:function(e,t,s){var i=new Error(s);return i.name="SuppressedError",i.error=e,i.suppressed=t,i};class Logger{constructor({name:e,isEnabled:t}){this.name=e;this.isEnabled=t;this.color=this.getColor(e)}getColor(e){let t=0;if(e.length===0){return""}for(let s=0;s<e.length;s++){t=e.charCodeAt(s)+((t<<5)-t);t=t&t}let s="#";for(let e=0;e<3;e++){let i=t>>e*8&255;s+=("00"+i.toString(16)).substr(-2)}return s.toString()}info(...e){const t=`color: ${this.color}; font-weight: bold;`;if(this.isEnabled){console.info(`%c${this.name}\n`,t,...e)}}debug(...e){if(this.isEnabled)console.log(`%c${this.name}\n`,`color: ${this.color}; font-weight: bold;`,...e)}error(...e){if(this.isEnabled)console.error(`%c${this.name}\n`,"color: white; background: #ce1a43; font-weight: bold;",...e)}warn(...e){if(this.isEnabled)console.warn(`%c${this.name}\n`,"color: white; background: #bf7506; font-weight: bold;",...e)}}function mapToKeyValue(e){const t=Object.create(null);for(const[s,i]of e){t[s]=i}return t}function registerEvent(e,t,s){e.addEventListener(t,s,false)}function getClickXandY(e){if(typeof e.pageY!=="undefined"&&typeof e.pageX!=="undefined"){return{x:e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:e.clientY+document.body.scrollTop+document.documentElement.scrollTop}}else{return{x:null,y:null}}}function UUID(){const e=crypto.getRandomValues(new Uint16Array(8));const t=[].map.call(e,(e=>e.toString(16).padStart(4,"0"))).join("");const s=(e[5]>>12&3|8).toString(16);return`${t.substr(0,8)}-${t.substr(8,4)}-4${t.substr(13,3)}-${s}${t.substr(17,3)}-${t.substr(20,12)}`}function getNow(){return(new Date).toISOString()}function getTimestamp(){return Math.floor((new Date).getTime()/1e3)}class LocalStorage{constructor(){this.localStorageSupported=typeof window!=="undefined"}set(e,t){if(this.localStorageSupported){localStorage.setItem(e,t)}}get(e){if(this.localStorageSupported){const t=localStorage.getItem(e);if(t){return t}else{return null}}else{return null}}setJson(e,t){if(this.localStorageSupported){localStorage.setItem(e,JSON.stringify(t))}}getJson(e){if(this.localStorageSupported){const t=localStorage.getItem(e);if(t){return JSON.parse(t)}else{return undefined}}else{return undefined}}remove(e){if(this.localStorageSupported){localStorage.removeItem(e)}}clear(){if(this.localStorageSupported){localStorage.clear()}}}class SessionController{constructor(e,t){this.config=e;this.core=t;this.logger=new Logger({name:"SessionController",isEnabled:this.config.log&&this.config.settings.session.log})}init(){return __awaiter(this,void 0,void 0,(function*(){const e=new LocalStorage;this.session=yield e.getJson(this.config.settings.session.storeName);if(this.session){const e=getTimestamp();if(e-this.session.lastEvent>=this.config.settings.session.duration){this.logger.debug(`Session timeout exceeded, starting new session`);yield this.startSession(this.session)}else{this.logger.debug(`Session active and not timed out, extending session ${this.session.sessionId}`);this.extendSession(Object.assign(Object.assign({},this.session),{lastEvent:e}))}}else{this.logger.debug("No active session");yield this.startSession()}}))}trackSessionEnd(e){return __awaiter(this,void 0,void 0,(function*(){if(this.config.settings.session.trackEvents){yield this.core.processActivity("session","SessionEnded",e)}}))}trackSessionStart(e){return __awaiter(this,void 0,void 0,(function*(){if(this.config.settings.session.trackEvents){yield this.core.processActivity("session","SessionStarted",e)}}))}startSession(){return __awaiter(this,arguments,void 0,(function*(e=undefined){const t=getTimestamp();if(e){yield this.trackSessionEnd(e)}this.sessionId=UUID();const s={sessionId:this.sessionId,firstEvent:t,lastEvent:t};yield(new LocalStorage).setJson(this.config.settings.session.storeName,s);yield this.trackSessionStart(s)}))}extendSession(e){return __awaiter(this,void 0,void 0,(function*(){this.sessionId=e.sessionId;yield(new LocalStorage).setJson(this.config.settings.session.storeName,e)}))}}class UserController{constructor(e,t){this.config=e;this.core=t;this.logger=new Logger({name:"UserController",isEnabled:this.config.log&&this.config.settings.user.log})}seedAnonymous(e){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("Seeding anonymous identity");this.userId=UUID();const t={id:this.userId,type:"anonymous"};if(this.config.settings.user.trackEvents){yield this.core.processActivity("identity","anonymous",t)}yield e.setJson(this.config.settings.user.storeName,t)}))}attemptIdentity(e){return __awaiter(this,void 0,void 0,(function*(){if(this.config.settings.user.seedAnonymous){yield this.seedAnonymous(e)}}))}init(){return __awaiter(this,void 0,void 0,(function*(){const e=new LocalStorage;const t=yield e.getJson(this.config.settings.user.storeName);if(!t){yield this.attemptIdentity(e)}else{this.userId=t.id;this.logger.debug(`identity is set as ${this.userId}`)}}))}}const e=600;const t=["title"];const s=["entity"];const i=["entity-id"];const n=["entity-props"];const r=["props"];const o=["dataset","attributes","innerText"];const a="bp-session";const c="bp-user";const l=60*5;const g="bp-queue";function applyIdentityStrategy(e,t){switch(t){case"userAndSession":e.user.enabled=true;e.session.enabled=true;break;case"user":e.user.enabled=true;e.session.enabled=false;break;case"session":e.user.enabled=false;e.session.enabled=true;break;case"noPii":e.user.enabled=false;e.session.enabled=false;break}return e}function getDefaultSettings(e,o){const d={transport:{apiRoute:"/api/activity",method:"sendBeacon"},queue:{store:"localStorage",storeName:g},page:{eventName:t,entity:s,entityId:i,entityProps:n,properties:r},user:{log:true,enabled:false,seedAnonymous:true,trackEvents:true,storeType:"localStorage",storeName:c},session:{log:true,enabled:false,trackEvents:true,storeType:"localStorage",storeName:a,duration:l}};return applyIdentityStrategy(d,o)}class BaseTracker{constructor(e,t,s){this.parent=e;this.core=t;this.logger=new Logger({name:s,isEnabled:this.core.config.log});this.enabled=true}sendTrack(e,t,s){this.logger.debug("track",{type:e,event:t,properties:s});if(this.core){this.core.processActivity(e,t,s)}}}function getPreferredMeta(e,t){for(const s of e){const e=t.querySelector(`meta[name=${s}]`);if(e){return e.getAttribute("content")}}return undefined}function getPreferredMetaList(e,t){const s=new Map;for(const i of e){const e=t.querySelector(`meta[name^=${i}]`);if(e){s.set(e.name.replace(`${i}-`,""),e.getAttribute("content"))}}return s}function getPageName(e,t){if(t.title){return t.title}else{return"PageViewed"}}function getPageProperties(e,t){const{document:s}=t;const i=getPreferredMetaList(e.config.settings.page.properties,s);return mapToKeyValue(i)}function getPageEntityProperties(e,t){var s;let i;let n;let r;i=getPreferredMeta((s=e.config.settings.page)===null||s===void 0?void 0:s.entity,t);if(i){n=getPreferredMeta(e.config.settings.page.entityId,t);r=getPreferredMetaList(e.config.settings.page.entityProps,t)}else{return undefined}return{type:i,id:n,props:r?mapToKeyValue(r):{}}}class PageTracker extends BaseTracker{constructor(t,s){super(t,s,"PageTracker");this.waitForIt=()=>new Promise((t=>setTimeout(t,e)))}init(){return __awaiter(this,void 0,void 0,(function*(){yield this.track()}))}track(){return __awaiter(this,void 0,void 0,(function*(){yield this.waitForIt();const e={pageName:getPageName(this.core,document),entity:getPageEntityProperties(this.core,document),properties:getPageProperties(this.core,window)};this.sendTrack("page","PageViewed",Object.assign(Object.assign({page:e.pageName},e.properties),e.entity&&{entity:e.entity}))}))}}class ClickTracker extends BaseTracker{constructor(e,t){super(e,t,"ClickTracker")}init(){return __awaiter(this,void 0,void 0,(function*(){const e=document.querySelectorAll("a");const t=document.querySelectorAll("button");for(const t of e){registerEvent(t,"click",(e=>{this.track("Link",e)}))}for(const e of t){registerEvent(e,"click",(e=>{this.track("Button",e)}))}}))}track(e="Link",t){if(t){const s=t.target;if(s){let i={event:t,properties:{}};let n;const r={pageName:getPageName(this.core,document),entity:getPageEntityProperties(this.core,document),properties:getPageProperties(this.core,window)};const{x:a,y:c}=getClickXandY(t);n=this.getMetaFromTrackedElement(e,o,s);i={event:n.event,properties:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},r.properties),n.properties),r.pageName&&{page:r.pageName}),{location:{x:a,y:c}}),r.entity||n.entity&&{entity:Object.assign(Object.assign({},r.entity),n.entity)})};this.sendTrack("track",i.event,i.properties)}}return false}getMetaFromTrackedElement(e,t,s){const i=`${e}Clicked`;const n=Object.assign(Object.assign(Object.assign(Object.assign({},s.getAttribute("id")&&{id:s.getAttribute("id")}),s.getAttribute("class")&&{class:s.getAttribute("class")}),s.getAttribute("href")&&{href:s.getAttribute("href")}),s.innerText&&{inner_text:s.innerText});for(const e of t){const t=s[e];if(t){if(e==="dataset"){return{event:i,entity:Object.assign(Object.assign({},t.entity&&{type:t.entity}),t.entityId&&{id:t.entityId}),properties:n}}}}return{event:i,entity:undefined,properties:{}}}}class FormTracker extends BaseTracker{constructor(e,t){super(e,t,"FormTracker")}init(){return __awaiter(this,void 0,void 0,(function*(){if(document.querySelectorAll("form").length===0){yield new Promise((e=>setTimeout(e,2e3)))}const e=document.querySelectorAll("form");for(const t of e){registerEvent(t,"submit",(e=>{this.track(e)}))}}))}track(e){if(e){e.preventDefault();const t=[];const s=e.target;if(s){const e={pageName:getPageName(this.core,document),entity:getPageEntityProperties(this.core,document),properties:getPageProperties(this.core,window)};const i=Object.assign(Object.assign({},s.getAttribute("id")&&{id:s.getAttribute("id")}),s.getAttribute("class")&&{class:s.getAttribute("class")});if(s.elements){for(const e of s.elements){if(e.id&&e.id!==""){t.push({key:e.id,value:e.value})}}}this.sendTrack("track","FormSubmitted",Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},e.properties),i&&{form:i}),t&&{formValues:t}),e.pageName&&{page:e.pageName}),e.entity&&{entity:e.entity}))}}return false}}let d;class Core{constructor(e,t=[]){d=this;this.loaded=false;this.enabled=false;this.window=e;this.trackers=new Map;this.config={log:false,identity:"noPii",apiRoot:"http://localhost",settings:getDefaultSettings(false,"noPii"),trackers:[]};this.logger=new Logger({name:"Core",isEnabled:true});this.logger.debug("version 0.2.0, built on April 18, 2024 07:22:56");this.sessionController=new SessionController(this.config,this);this.userController=new UserController(this.config,this)}getConfig(){return this.config}registerTrackers(){return __awaiter(this,void 0,void 0,(function*(){for(const e of this.config.trackers){switch(e){case"page":this.trackers.set("page",new PageTracker(this.window,this));break;case"click":this.trackers.set("click",new ClickTracker(this.window,this));break;case"form":this.trackers.set("form",new FormTracker(this.window,this));break;default:this.logger.warn(`Tracker ${e} doesnt exist and cannot be registered`);break}}this.trackers.forEach((e=>__awaiter(this,void 0,void 0,(function*(){e.init&&(yield e.init())}))))}))}init(e){return __awaiter(this,void 0,void 0,(function*(){if(e){this.logger.debug("config loaded",e);this.applyConfig(e)}if(this.config.settings.user.enabled)yield this.userController.init();if(this.config.settings.session.enabled)yield this.sessionController.init();yield this.registerTrackers();this.loaded=true}))}mergeConfig(e,t){Object.keys(t).forEach((s=>{if(e.hasOwnProperty(s)&&typeof e[s]==="object"&&!(e[s]instanceof Array)){this.mergeConfig(e[s],t[s])}else{e[s]=t[s]}}));return e}applyConfig(e){this.mergeConfig(this.config,e);this.config.settings=applyIdentityStrategy(this.config.settings,this.config.identity);this.enabled=true}track(e,t,s){if(e==="track"||e==="event"){this.processActivity(e,t,s)}else if(e==="click"){let i=this.trackers.get(e);if(!i){i=new ClickTracker(this.window,this)}i.track(t,s)}else if(e==="page"){let t=this.trackers.get(e);if(!t){t=new PageTracker(this.window,this)}t.track()}else if(e==="form"){const t=this.trackers.get(e);(t===null||t===void 0?void 0:t.track)&&t.track()}else{this.logger.warn(`track type of ${e} doesn't exist`)}}trackLinkClick(e){d.track("click",`Link`,e)}trackButtonClick(e){d.track("click",`Button`,e)}trackCurrentPage(){d.track("page","PageViewed",{})}autoTrack(){this.trackers.forEach((e=>{e.track&&e.track()}))}processActivity(e,t,s){return __awaiter(this,void 0,void 0,(function*(){const{screen:{width:i,height:n},navigator:{language:r,userAgent:o},location:{hostname:a,pathname:c,search:l},document:g}=window;let d={channel:"web",screen:`${i}x${n}`,language:r,userAgent:o,url:`${c}${l}`,referrer:g.referrer,hostname:a};if(this.userController&&this.userController.userId){d=Object.assign({userId:this.userController.userId},d)}if(this.sessionController&&this.sessionController.sessionId){d=Object.assign({sessionId:this.sessionController.sessionId},d)}const u={type:e,event:t,properties:s,context:d,originalTimestamp:getNow()};this.logger.debug("sendToApi",u);yield this.sendActivity(u)}))}sendActivity(e){return __awaiter(this,void 0,void 0,(function*(){if(this.config.settings.transport.method==="sendBeacon"){const t=new Blob([JSON.stringify(e)]);navigator.sendBeacon(`${this.config.apiRoot}${this.config.settings.transport.apiRoute}`,t)}}))}}(e=>{if(!e.beacon){e.beacon=new Core(e);const t=document.getElementById("beaconScript");if(t){const s=t.getAttribute("data-api-root");const i=t.getAttribute("data-identity")?t.getAttribute("data-identity"):"noPii";let n=t.getAttribute("data-trackers")?t.getAttribute("data-trackers"):["page"];if(n&&n.indexOf(",")>-1){n=n.split(",")}if(s){e.beacon.init({apiRoot:s,identity:i,trackers:n})}}}})(window)})();